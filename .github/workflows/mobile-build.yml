name: mobile - Build On Cloud

on:
  workflow_dispatch:

jobs:
  build:
    name: Build APK on EAS Cloud
    runs-on: ubuntu-latest
    environment:
      name: production
    defaults:
      run:
        working-directory: ./mobile

    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'
          cache-dependency-path: mobile/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Setup EAS
        run: npm install -g eas-cli

      - name: Extract Release Info
        id: extract_info
        run: |
          NATIVE_VER=$(jq -r '.versions[0].nativeVersion' versions.json)
          NOTES=$(jq -r '.versions[0].updates[] | "- " + .date + ": " + .message' versions.json)
          
          echo "NATIVE_VER=$NATIVE_VER" >> $GITHUB_ENV
          
          mkdir -p build_assets
          echo "$NATIVE_VER" > build_assets/version.txt
          
          echo "## Ver $NATIVE_VER" > build_assets/body.txt
          echo "" >> build_assets/body.txt
          echo "### Updates in this version" >> build_assets/body.txt
          echo "$NOTES" >> build_assets/body.txt
          echo "" >> build_assets/body.txt
          echo "ğŸ“… Built at: $(date +'%Y-%m-%d')" >> build_assets/body.txt

      - name: Build on Cloud & Download
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          APP_VERSION: ${{ env.NATIVE_VER }}
          
          EXPO_PUBLIC_DISCORD_WEBHOOK_URL: ${{ secrets.EXPO_PUBLIC_DISCORD_WEBHOOK_URL }}
        run: |
          FILENAME="vrcp-${{ env.NATIVE_VER }}.apk"

          # 1. ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ“ãƒ«ãƒ‰ã‚’é–‹å§‹ã—ã€JSONã§çµæœã‚’å—ã‘å–ã‚‹
          #    --no-wait: ã‚³ãƒãƒ³ãƒ‰ã¯ã™ãçµ‚äº†ã•ã›ã¦IDã ã‘ã‚‚ã‚‰ã†
          echo "Triggering cloud build..."
          eas build --platform android --profile prod-apk --non-interactive --no-wait --json > build_info.json
          
          # JSONã‹ã‚‰ãƒ“ãƒ«ãƒ‰IDã‚’æŠ½å‡º
          BUILD_ID=$(jq -r '.[0].id' build_info.json)
          echo "Build ID: $BUILD_ID"

          # 2. ãƒ“ãƒ«ãƒ‰ãŒçµ‚ã‚ã‚‹ã¾ã§å¾…æ©Ÿã™ã‚‹
          echo "Waiting for build to finish..."
          eas build:wait --id $BUILD_ID

          # 3. å®Œäº†ã—ãŸãƒ“ãƒ«ãƒ‰æƒ…å ±ã‚’å–å¾—ã—ã¦ã€APKã®URLã‚’æŠœãå‡ºã™
          echo "Fetching download URL..."
          eas build:view --id $BUILD_ID --json > build_result.json
          APK_URL=$(jq -r '.artifacts.buildUrl' build_result.json)
          
          echo "URL: $APK_URL"
          # 4. URLã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ä¿å­˜
          echo "Downloading APK..."
          curl -L -o "./build_assets/$FILENAME" "$APK_URL"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mobile-build-artifacts
          path: ./mobile/build_assets/
          retention-days: 3